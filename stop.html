<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stop & Note</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body{font-family:system-ui, sans-serif;margin:12px}
    label{display:block;font-size:12px;color:#555;margin-bottom:6px}
    textarea{width:100%;height:72px;padding:8px}
    .row{margin-top:10px;display:flex;gap:8px}
    button{padding:8px 12px;cursor:pointer}
  </style>
</head>
<body>
  <label for="note">Brief description</label>
  <textarea id="note" placeholder="What did you do?"></textarea>
  <div class="row">
    <button id="cancelBtn" type="button">Cancel</button>
    <button id="saveBtn" type="button">Save</button>
  </div>

  <script>
    const t = TrelloPowerUp.iframe();

    async function stopWithNote() {
      const start = await t.get('card','shared','timerStart');
      if (!start) {
        await t.alert({ message: 'No running timer found.', duration: 3 });
        return t.closePopup();
      }
      const end = Date.now();
      const seconds = Math.max(0, Math.round((end - start) / 1000));
      const note = (document.getElementById('note').value || '').trim();

      const sessions = await t.get('card','shared','sessions') || [];
      const member = await t.member('id'); // lightweight user ref
      sessions.push({ start, end, seconds, note, by: member });

      await t.set('card','shared','sessions', sessions);
      await t.remove('card','shared','timerStart');

      await t.closePopup();
      return t.alert({ message: 'Time saved.', duration: 3 });
    }

    document.getElementById('saveBtn').addEventListener('click', stopWithNote);
    document.getElementById('cancelBtn').addEventListener('click', () => t.closePopup());
    document.getElementById('note').focus();
  </script>
</body>
</html>
f